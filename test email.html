<?php

// Set the correct content type for the response
header('Content-Type: application/json');

// Get the raw POST data
$json_data = file_get_contents('php://input');

// Decode the JSON data into a PHP associative array
$data = json_decode($json_data, true);

// Check if decoding was successful and data is present
if (!$data || !isset($data['emailAddress'])) {
    http_response_code(400); // Bad Request
    echo json_encode(['status' => 'error', 'message' => 'Invalid data received.']);
    exit;
}

// Extract data from the POST request
$clientName = $data['clientName'] ?? 'N/A';
$contactNumber = $data['contactNumber'] ?? 'N/A';
$clientEmail = $data['emailAddress'];

// Define the internal recipient email
$internalEmail = 'kamran.yaqub@mfsuk.com';

// Define recipients for the email
$to = $clientEmail;
$cc = $internalEmail;

$subject = 'Your Bridging Loan Quote from MFS';

// Function to format currency
function fmtMoney0($value) {
    return 'Â£' . number_format($value, 0);
}

// Function to format percentage
function fmtPct($value) {
    return number_format($value * 100, 2) . '%';
}

// Build the HTML email content
$html_body = "
<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Bridging Loan Quote</title>
    <style>
        body { font-family: 'Arial', sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 600px; margin: 20px auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { color: #004085; }
        .section { margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 15px; }
        .section-title { font-size: 1.2em; font-weight: bold; color: #555; margin-bottom: 10px; }
        .quote-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .quote-table th, .quote-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .quote-table th { background-color: #e2f3ff; color: #004085; font-weight: bold; }
        .quote-table tr:nth-child(even) { background-color: #f4f4f4; }
        .highlight { background-color: #e6f7ff; font-weight: bold; }
        .footer { text-align: center; margin-top: 20px; font-size: 0.8em; color: #777; }
    </style>
</head>
<body>
    <div class='container'>
        <div class='header'>
            <h1>Bridging Loan Quote</h1>
            <p>Prepared for: **" . htmlspecialchars($clientName) . "**</p>
            <p>Contact: **" . htmlspecialchars($contactNumber) . "** | **" . htmlspecialchars($clientEmail) . "**</p>
        </div>
        
        <div class='section'>
            <div class='section-title'>Loan Details</div>
            <p><strong>Charge Type:</strong> " . htmlspecialchars($data['chargeType']) . "</p>
            <p><strong>Property Type:</strong> " . htmlspecialchars($data['propertyType']) . "</p>
            <p><strong>Sub Product Type:</strong> " . htmlspecialchars($data['loanProduct']) . "</p>
        </div>
        
        <div class='section'>
            <div class='section-title'>Summary of Results</div>
            <table class='quote-table'>
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th style='background-color: #cceeff;'>Fixed Bridge</th>
                        <th style='background-color: #c2f0c2;'>Variable Bridge</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Gross Loan</td>
                        <td>" . fmtMoney0($data['fixedResults']['grossLoan']) . "</td>
                        <td>" . fmtMoney0($data['variableResults']['grossLoan']) . "</td>
                    </tr>
                    <tr>
                        <td>Net Loan</td>
                        <td>" . fmtMoney0($data['fixedResults']['netLoan']) . "</td>
                        <td>" . fmtMoney0($data['variableResults']['netLoan']) . "</td>
                    </tr>
                    <tr>
                        <td>Monthly Rate (Full)</td>
                        <td>" . fmtPct($data['fixedResults']['fullMonthlyRate']) . "</td>
                        <td>" . fmtPct($data['variableResults']['fullMonthlyRate']) . "</td>
                    </tr>
                    <tr>
                        <td>Total Repayment</td>
                        <td>" . fmtMoney0($data['fixedResults']['totalRepayment']) . "</td>
                        <td>" . fmtMoney0($data['variableResults']['totalRepayment']) . "</td>
                    </tr>
                    <tr>
                        <td>Rolled Interest</td>
                        <td>" . fmtMoney0($data['fixedResults']['rolledInterest']) . "</td>
                        <td>" . fmtMoney0($data['variableResults']['rolledInterest']) . "</td>
                    </tr>
                    <tr>
                        <td>Monthly Direct Debit</td>
                        <td>" . fmtMoney0($data['fixedResults']['monthlyDirectDebit']) . "</td>
                        <td>" . fmtMoney0($data['variableResults']['monthlyDirectDebit']) . "</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class='footer'>
            <p>This is an automated quote. Please contact us for a final offer.</p>
        </div>
    </div>
</body>
</html>
";

// Set headers for HTML email
$headers = "MIME-Version: 1.0" . "\r\n";
$headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";
$headers .= 'From: <no-reply@yourwebsite.com>' . "\r\n"; // Replace with your domain email
$headers .= "Cc: " . $cc . "\r\n";

// Attempt to send the email
if (mail($to, $subject, $html_body, $headers)) {
    http_response_code(200);
    echo json_encode(['status' => 'success', 'message' => 'Email sent successfully.']);
} else {
    http_response_code(500); // Internal Server Error
    echo json_encode(['status' => 'error', 'message' => 'Failed to send email.']);
}
?>
